<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PokeStatsBR - Detalhes do Pokémon">
    <title>Carregando... - PokeStatsBR</title>
    <link rel="icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" alt="Pokeball" class="logo-icon">
                <span class="logo-text">PokeStats<span class="logo-br">BR</span></span>
            </a>
            <nav class="nav">
                <a href="index.html" class="nav-link">Formatos</a>
                <a href="about.html" class="nav-link">Sobre</a>
                <a href="https://pokemonshowdown.com" target="_blank" rel="noopener" class="nav-link external">Showdown</a>
            </nav>
            <button class="mobile-menu-btn" aria-label="Menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html" class="mobile-menu-link">Formatos</a>
        <a href="about.html" class="mobile-menu-link">Sobre</a>
        <a href="https://pokemonshowdown.com" target="_blank" rel="noopener" class="mobile-menu-link">Showdown</a>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="index.html">Formatos</a>
                <span class="breadcrumb-sep">/</span>
                <a href="#" id="breadcrumb-format-link">Formato</a>
                <span class="breadcrumb-sep">/</span>
                <span class="breadcrumb-current" id="breadcrumb-pokemon">Carregando...</span>
            </nav>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando dados...</p>
            </div>

            <!-- Error -->
            <div id="error" class="error hidden">
                <p>Pokémon não encontrado.</p>
                <a href="index.html" class="btn btn-primary">Voltar</a>
            </div>

            <!-- Pokemon Details -->
            <div id="pokemon-details" class="pokemon-details hidden">
                <!-- Header -->
                <header class="pokemon-header">
                    <div class="pokemon-header-main">
                        <img id="pokemon-sprite" src="" alt="" class="pokemon-sprite-large">
                        <div class="pokemon-header-info">
                            <h1 id="pokemon-name" class="pokemon-title"></h1>
                            <div class="pokemon-meta">
                                <span class="meta-item rank"><strong>Rank:</strong> <span id="pokemon-rank">#-</span></span>
                                <span class="meta-item usage"><strong>Uso:</strong> <span id="pokemon-usage">-%</span></span>
                            </div>
                        </div>
                    </div>
                    <button id="export-btn" class="btn btn-primary export-btn">Exportar para Showdown</button>
                </header>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <!-- Moves -->
                    <section class="stats-section">
                        <h2 class="stats-section-title">Movimentos</h2>
                        <div id="moves-list" class="stats-list"></div>
                    </section>

                    <!-- Items -->
                    <section class="stats-section">
                        <h2 class="stats-section-title">Itens</h2>
                        <div id="items-list" class="stats-list"></div>
                    </section>

                    <!-- Abilities -->
                    <section class="stats-section">
                        <h2 class="stats-section-title">Habilidades</h2>
                        <div id="abilities-list" class="stats-list"></div>
                    </section>

                    <!-- Tera Types -->
                    <section class="stats-section" id="tera-section">
                        <h2 class="stats-section-title">Tipos Tera</h2>
                        <div id="tera-list" class="stats-list tera-types"></div>
                    </section>

                    <!-- EV Spreads -->
                    <section class="stats-section spreads-section">
                        <h2 class="stats-section-title">Distribuições de EVs</h2>
                        <div id="spreads-list" class="spreads-list"></div>
                    </section>

                    <!-- Teammates -->
                    <section class="stats-section teammates-section">
                        <h2 class="stats-section-title">Parceiros de Time</h2>
                        <div id="teammates-list" class="teammates-grid"></div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Export Modal -->
    <div id="export-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exportar Set</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="export-text" readonly></textarea>
                <button id="copy-btn" class="btn btn-primary" onclick="copyToClipboard()">Copiar para Área de Transferência</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>Pokémon e todos os nomes relacionados são marca registrada Nintendo 1996-2024.</p>
            </div>
        </div>
    </footer>

    <script src="static/js/main.js"></script>
    <script>
        // Get params from URL
        const urlParams = new URLSearchParams(window.location.search);
        const FORMAT_CODE = urlParams.get('format') || 'gen9ou';
        const POKEMON_NAME = urlParams.get('pokemon') || '';
        const RATING = urlParams.get('rating') || '1760';
        const MONTH = urlParams.get('month') || '2024-11';

        // Format names
        const FORMAT_NAMES = {
            'gen9vgc2025regh': '[Gen 9] VGC 2025 Reg H',
            'gen9vgc2025regg': '[Gen 9] VGC 2025 Reg G',
            'gen9ou': '[Gen 9] OverUsed',
            'gen9ubers': '[Gen 9] Ubers',
            'gen9uu': '[Gen 9] UnderUsed',
            'gen9ru': '[Gen 9] RarelyUsed',
            'gen9nu': '[Gen 9] NeverUsed',
            'gen9pu': '[Gen 9] PU',
            'gen9lc': '[Gen 9] Little Cup',
            'gen9monotype': '[Gen 9] Monotype',
            'gen9doublesou': '[Gen 9] Doubles OU',
            'gen9doublesubers': '[Gen 9] Doubles Ubers',
            'gen9doublesuu': '[Gen 9] Doubles UU',
            'gen9nationaldex': '[Gen 9] National Dex',
            'gen9nationaldexubers': '[Gen 9] National Dex Ubers',
            'gen9nationaldexmonotype': '[Gen 9] National Dex Monotype',
            'gen9anythinggoes': '[Gen 9] Anything Goes',
            'gen9randombattle': '[Gen 9] Random Battle',
            'gen9balancedhackmons': '[Gen 9] Balanced Hackmons',
            'gen91v1': '[Gen 9] 1v1',
            'gen8ou': '[Gen 8] OverUsed',
            'gen7ou': '[Gen 7] OverUsed',
            'gen6ou': '[Gen 6] OverUsed',
            'gen5ou': '[Gen 5] OverUsed',
        };

        // Type colors
        const typeColors = {
            'Normal': '#A8A878', 'Fire': '#F08030', 'Water': '#6890F0', 'Electric': '#F8D030',
            'Grass': '#78C850', 'Ice': '#98D8D8', 'Fighting': '#C03028', 'Poison': '#A040A0',
            'Ground': '#E0C068', 'Flying': '#A890F0', 'Psychic': '#F85888', 'Bug': '#A8B820',
            'Rock': '#B8A038', 'Ghost': '#705898', 'Dragon': '#7038F8', 'Dark': '#705848',
            'Steel': '#B8B8D0', 'Fairy': '#EE99AC', 'Stellar': '#44AACC'
        };

        let pokemonData = null;
        let allData = null;

        // Get Showdown sprite
        function getShowdownSprite(name) {
            const normalized = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            return `https://play.pokemonshowdown.com/sprites/gen5/${normalized}.png`;
        }

        // Calculate percentages from counts
        function calcPercentages(obj, topN = 10) {
            if (!obj) return [];
            const total = Object.values(obj).reduce((a, b) => a + b, 0);
            if (total === 0) return [];
            return Object.entries(obj)
                .map(([name, count]) => ({ name, percentage: (count / total) * 100 }))
                .sort((a, b) => b.percentage - a.percentage)
                .slice(0, topN);
        }

        // Create stat bar
        function createStatBar(name, percentage) {
            return `
                <div class="stat-item">
                    <div class="stat-header">
                        <span class="stat-name">${name}</span>
                        <span class="stat-percentage">${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                </div>
            `;
        }

        // Create Tera badge
        function createTeraBadge(type, percentage) {
            const color = typeColors[type] || '#888';
            return `
                <div class="tera-badge" style="background-color: ${color}">
                    <span class="tera-name">${type}</span>
                    <span class="tera-percentage">${percentage.toFixed(1)}%</span>
                </div>
            `;
        }

        // Parse spread string
        function parseSpread(spreadStr, count, total) {
            try {
                const [nature, evs] = spreadStr.split(':');
                const [hp, atk, def, spa, spd, spe] = evs.split('/').map(Number);
                return { nature, hp, atk, def, spa, spd, spe, percentage: (count / total) * 100, raw: spreadStr };
            } catch {
                return null;
            }
        }

        // Create spread card
        function createSpreadCard(spread) {
            const evList = [];
            if (spread.hp > 0) evList.push(`${spread.hp} HP`);
            if (spread.atk > 0) evList.push(`${spread.atk} Atk`);
            if (spread.def > 0) evList.push(`${spread.def} Def`);
            if (spread.spa > 0) evList.push(`${spread.spa} SpA`);
            if (spread.spd > 0) evList.push(`${spread.spd} SpD`);
            if (spread.spe > 0) evList.push(`${spread.spe} Spe`);

            return `
                <div class="spread-card">
                    <div class="spread-header">
                        <span class="spread-nature">${spread.nature}</span>
                        <span class="spread-percentage">${spread.percentage.toFixed(1)}%</span>
                    </div>
                    <div class="spread-evs">${evList.join(' / ')}</div>
                </div>
            `;
        }

        // Create teammate card
        function createTeammateCard(name, score) {
            const sprite = getShowdownSprite(name);
            return `
                <a href="pokemon.html?format=${FORMAT_CODE}&pokemon=${encodeURIComponent(name)}&rating=${RATING}&month=${MONTH}"
                   class="teammate-card">
                    <img src="${sprite}" alt="${name}" class="teammate-sprite"
                         onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'">
                    <span class="teammate-name">${name}</span>
                    <span class="teammate-score">${(score * 100).toFixed(1)}%</span>
                </a>
            `;
        }

        // Generate Showdown set
        function generateShowdownSet(data) {
            const lines = [data.name];

            // Item
            const items = calcPercentages(data.Items, 1);
            if (items.length > 0) lines[0] += ` @ ${items[0].name}`;

            // Ability
            const abilities = calcPercentages(data.Abilities, 1);
            if (abilities.length > 0) lines.push(`Ability: ${abilities[0].name}`);

            // Tera Type
            const teraTypes = calcPercentages(data['Tera Types'], 1);
            if (teraTypes.length > 0) lines.push(`Tera Type: ${teraTypes[0].name}`);

            // EVs from top spread
            if (data.Spreads) {
                const spreads = Object.entries(data.Spreads);
                if (spreads.length > 0) {
                    const topSpread = spreads.sort((a, b) => b[1] - a[1])[0][0];
                    const parsed = parseSpread(topSpread, 1, 1);
                    if (parsed) {
                        const evList = [];
                        if (parsed.hp > 0) evList.push(`${parsed.hp} HP`);
                        if (parsed.atk > 0) evList.push(`${parsed.atk} Atk`);
                        if (parsed.def > 0) evList.push(`${parsed.def} Def`);
                        if (parsed.spa > 0) evList.push(`${parsed.spa} SpA`);
                        if (parsed.spd > 0) evList.push(`${parsed.spd} SpD`);
                        if (parsed.spe > 0) evList.push(`${parsed.spe} Spe`);
                        if (evList.length > 0) lines.push(`EVs: ${evList.join(' / ')}`);
                        lines.push(`${parsed.nature} Nature`);
                    }
                }
            }

            // Top 4 moves
            const moves = calcPercentages(data.Moves, 4);
            moves.forEach(m => lines.push(`- ${m.name}`));

            return lines.join('\n');
        }

        // Render Pokemon details
        function renderDetails(data, rank) {
            pokemonData = data;

            const formatName = FORMAT_NAMES[FORMAT_CODE] || FORMAT_CODE;
            document.title = `${data.name} - ${formatName} - PokeStatsBR`;
            document.getElementById('breadcrumb-format-link').href = `format.html?format=${FORMAT_CODE}`;
            document.getElementById('breadcrumb-format-link').textContent = formatName;
            document.getElementById('breadcrumb-pokemon').textContent = data.name;

            // Header
            document.getElementById('pokemon-sprite').src = getShowdownSprite(data.name);
            document.getElementById('pokemon-sprite').alt = data.name;
            document.getElementById('pokemon-name').textContent = data.name;
            document.getElementById('pokemon-rank').textContent = `#${rank}`;
            document.getElementById('pokemon-usage').textContent = `${(data.usage * 100).toFixed(2)}%`;

            // Moves
            const moves = calcPercentages(data.Moves, 10);
            document.getElementById('moves-list').innerHTML = moves.map(m => createStatBar(m.name, m.percentage)).join('');

            // Items
            const items = calcPercentages(data.Items, 10);
            document.getElementById('items-list').innerHTML = items.map(i => createStatBar(i.name, i.percentage)).join('');

            // Abilities
            const abilities = calcPercentages(data.Abilities);
            document.getElementById('abilities-list').innerHTML = abilities.map(a => createStatBar(a.name, a.percentage)).join('');

            // Tera Types
            const teraSection = document.getElementById('tera-section');
            const teraTypes = calcPercentages(data['Tera Types']);
            if (teraTypes.length > 0) {
                document.getElementById('tera-list').innerHTML = teraTypes.map(t => createTeraBadge(t.name, t.percentage)).join('');
                teraSection.classList.remove('hidden');
            } else {
                teraSection.classList.add('hidden');
            }

            // Spreads
            if (data.Spreads) {
                const spreadsTotal = Object.values(data.Spreads).reduce((a, b) => a + b, 0);
                const spreads = Object.entries(data.Spreads)
                    .map(([str, count]) => parseSpread(str, count, spreadsTotal))
                    .filter(s => s !== null)
                    .sort((a, b) => b.percentage - a.percentage)
                    .slice(0, 10);
                document.getElementById('spreads-list').innerHTML = spreads.map(s => createSpreadCard(s)).join('');
            }

            // Teammates
            if (data.Teammates) {
                const teammates = Object.entries(data.Teammates)
                    .filter(([, score]) => score > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                document.getElementById('teammates-list').innerHTML = teammates.map(([name, score]) => createTeammateCard(name, score)).join('');
            }
        }

        // Load data
        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const details = document.getElementById('pokemon-details');

            try {
                const smogonUrl = `https://www.smogon.com/stats/${MONTH}/chaos/${FORMAT_CODE}-${RATING}.json`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(smogonUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Not found');

                allData = await response.json();

                // Find Pokemon (case insensitive)
                let foundData = null;
                let rank = 0;

                const sortedPokemon = Object.entries(allData.data)
                    .sort((a, b) => b[1].usage - a[1].usage);

                for (let i = 0; i < sortedPokemon.length; i++) {
                    const [name, data] = sortedPokemon[i];
                    if (name.toLowerCase() === POKEMON_NAME.toLowerCase()) {
                        foundData = { name, ...data };
                        rank = i + 1;
                        break;
                    }
                }

                if (!foundData) throw new Error('Pokemon not found');

                renderDetails(foundData, rank);

                loading.classList.add('hidden');
                details.classList.remove('hidden');

            } catch (err) {
                console.error('Error:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }

        // Modal functions
        function openModal() {
            if (!pokemonData) return;
            const rawData = allData.data[pokemonData.name];
            rawData.name = pokemonData.name;
            document.getElementById('export-text').value = generateShowdownSet(rawData);
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        function copyToClipboard() {
            const textarea = document.getElementById('export-text');
            textarea.select();
            document.execCommand('copy');
            const btn = document.getElementById('copy-btn');
            btn.textContent = 'Copiado!';
            setTimeout(() => btn.textContent = 'Copiar para Área de Transferência', 2000);
        }

        // Event listeners
        document.getElementById('export-btn').addEventListener('click', openModal);
        document.getElementById('export-modal').addEventListener('click', (e) => {
            if (e.target.id === 'export-modal') closeModal();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>
