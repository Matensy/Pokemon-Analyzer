{% extends "base.html" %}

{% block title %}Team Builder - PokeStatsBR{% endblock %}

{% block head %}
<style>
    .builder-header { text-align: center; margin-bottom: 2rem; }
    .builder-header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .builder-header h1 span { color: var(--secondary); }
    .builder-header p { color: var(--text-secondary); }

    .format-select-row {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .builder-select {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        min-width: 200px;
    }

    .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .team-slot {
        background: var(--bg-card);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .team-slot:hover { border-color: var(--primary); }
    .team-slot.filled { border-style: solid; border-color: var(--primary); }

    .team-slot-sprite { width: 96px; height: 96px; image-rendering: pixelated; }
    .team-slot-name { font-weight: 600; margin-top: 0.5rem; }
    .team-slot-remove {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .team-slot-empty {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .add-pokemon-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .add-pokemon-section h3 { margin-bottom: 1rem; }

    .pokemon-search {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .pokemon-search input {
        flex: 1;
        min-width: 200px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 0.75rem 1rem;
    }

    .search-results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .search-result {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .search-result:hover { background: var(--bg-card-hover); }
    .search-result img { width: 40px; height: 40px; image-rendering: pixelated; }
    .search-result span { font-size: 0.8rem; }

    .ai-section {
        background: linear-gradient(135deg, var(--bg-card) 0%, #1a2a1a 100%);
        border: 2px solid var(--primary);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .ai-section h3 { color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

    .ai-suggestions {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .ai-suggestion {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .ai-suggestion:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 156, 59, 0.3); }
    .ai-suggestion-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .ai-suggestion-header img { width: 48px; height: 48px; image-rendering: pixelated; }
    .ai-suggestion-header strong { font-size: 1rem; }
    .ai-suggestion-role { font-size: 0.75rem; color: var(--primary); margin-left: auto; }
    .ai-suggestion-reason { font-size: 0.8rem; color: var(--text-secondary); }

    .ai-tip {
        background: var(--bg-secondary);
        border-left: 4px solid var(--secondary);
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .export-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }
    .export-section h3 { margin-bottom: 1rem; }
    .export-textarea {
        width: 100%;
        height: 300px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: monospace;
        padding: 1rem;
        resize: vertical;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <header class="builder-header">
        <h1>Team <span>Builder</span></h1>
        <p>Monte seu time e receba sugest√µes de uma IA</p>
    </header>

    <div class="format-select-row">
        <select id="format-select" class="builder-select">
            {% for key, category in formats.items() %}
            <optgroup label="{{ category.nome }}">
                {% for code, name in category.formatos.items() %}
                <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
            </optgroup>
            {% endfor %}
        </select>
        <select id="rating-select" class="builder-select">
            <option value="1760">Rating 1760 (Top)</option>
            <option value="1630">Rating 1630</option>
            <option value="1500">Rating 1500</option>
            <option value="0">Rating 0 (Todos)</option>
        </select>
    </div>

    <!-- Team Slots -->
    <div class="team-grid" id="team-grid">
        <div class="team-slot" data-slot="0"><span class="team-slot-empty">Slot 1</span></div>
        <div class="team-slot" data-slot="1"><span class="team-slot-empty">Slot 2</span></div>
        <div class="team-slot" data-slot="2"><span class="team-slot-empty">Slot 3</span></div>
        <div class="team-slot" data-slot="3"><span class="team-slot-empty">Slot 4</span></div>
        <div class="team-slot" data-slot="4"><span class="team-slot-empty">Slot 5</span></div>
        <div class="team-slot" data-slot="5"><span class="team-slot-empty">Slot 6</span></div>
    </div>

    <!-- Add Pokemon -->
    <section class="add-pokemon-section">
        <h3>Adicionar Pokemon</h3>
        <div class="pokemon-search">
            <input type="text" id="pokemon-search" placeholder="Buscar Pokemon..." oninput="searchPokemon()">
            <button class="btn" onclick="loadTopPokemon()">Ver Top 20</button>
        </div>
        <div class="search-results" id="search-results"></div>
    </section>

    <!-- AI Suggestions -->
    <section class="ai-section">
        <h3>Sugestoes da IA</h3>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Adicione alguns Pokemon ao seu time e clique no botao para receber sugestoes personalizadas.
        </p>
        <button class="btn" id="suggest-btn" onclick="getSuggestions()">Pedir Sugestoes</button>
        <div id="ai-suggestions" class="ai-suggestions"></div>
        <div id="ai-tip" class="ai-tip hidden"></div>
        <div id="ai-error" class="error hidden" style="padding: 1rem;"></div>
    </section>

    <!-- Export -->
    <section class="export-section">
        <h3>Exportar Time</h3>
        <textarea id="export-text" class="export-textarea" readonly placeholder="Adicione Pokemon ao seu time para ver o export..."></textarea>
        <button class="btn" onclick="copyExport()">Copiar para Area de Transferencia</button>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    let team = [null, null, null, null, null, null];
    let pokemonCache = {};

    function getSprite(name) {
        const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        return `https://play.pokemonshowdown.com/sprites/gen5/${cleanName}.png`;
    }

    function updateTeamUI() {
        const grid = document.getElementById('team-grid');
        team.forEach((pokemon, i) => {
            const slot = grid.children[i];
            if (pokemon) {
                slot.classList.add('filled');
                slot.innerHTML = `
                    <img src="${getSprite(pokemon.name)}" class="team-slot-sprite" onerror="this.style.opacity='0.3'">
                    <span class="team-slot-name">${pokemon.name}</span>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">${pokemon.usage ? pokemon.usage.toFixed(1) + '%' : ''}</span>
                    <button class="team-slot-remove" onclick="removePokemon(${i})">Remover</button>
                `;
            } else {
                slot.classList.remove('filled');
                slot.innerHTML = `<span class="team-slot-empty">Slot ${i + 1}</span>`;
            }
        });
        updateExport();
    }

    function addPokemon(pokemon) {
        const emptySlot = team.findIndex(p => p === null);
        if (emptySlot === -1) {
            alert('Time completo! Remova um Pokemon primeiro.');
            return;
        }
        team[emptySlot] = pokemon;
        updateTeamUI();
    }

    function removePokemon(index) {
        team[index] = null;
        updateTeamUI();
    }

    async function loadTopPokemon() {
        const format = document.getElementById('format-select').value;
        const rating = document.getElementById('rating-select').value;
        const results = document.getElementById('search-results');

        results.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        try {
            const res = await fetch(`/api/stats/${format}?rating=${rating}`);
            if (!res.ok) throw new Error('Erro ao carregar dados');

            const data = await res.json();
            pokemonCache = data.pokemon;

            const top20 = data.ranked_list.slice(0, 20);
            results.innerHTML = top20.map(p => `
                <div class="search-result" onclick='addPokemon(${JSON.stringify(pokemonCache[p.name]).replace(/'/g, "&#39;")})'>
                    <img src="${getSprite(p.name)}" onerror="this.style.opacity='0.3'">
                    <span>${p.name} (${p.usage.toFixed(1)}%)</span>
                </div>
            `).join('');
        } catch (e) {
            results.innerHTML = `<p class="error">${e.message}</p>`;
        }
    }

    function searchPokemon() {
        const query = document.getElementById('pokemon-search').value.toLowerCase();
        const results = document.getElementById('search-results');

        if (!query || Object.keys(pokemonCache).length === 0) {
            results.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">Clique em "Ver Top 20" primeiro para carregar os Pokemon.</p>';
            return;
        }

        const matches = Object.values(pokemonCache)
            .filter(p => p.name.toLowerCase().includes(query))
            .slice(0, 20);

        if (matches.length === 0) {
            results.innerHTML = '<p style="color: var(--text-muted);">Nenhum Pokemon encontrado.</p>';
            return;
        }

        results.innerHTML = matches.map(p => `
            <div class="search-result" onclick='addPokemon(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                <img src="${getSprite(p.name)}" onerror="this.style.opacity='0.3'">
                <span>${p.name} (${p.usage.toFixed(1)}%)</span>
            </div>
        `).join('');
    }

    async function getSuggestions() {
        const format = document.getElementById('format-select').value;
        const currentTeam = team.filter(p => p !== null);
        const suggestionsDiv = document.getElementById('ai-suggestions');
        const tipDiv = document.getElementById('ai-tip');
        const errorDiv = document.getElementById('ai-error');
        const btn = document.getElementById('suggest-btn');

        suggestionsDiv.innerHTML = '';
        tipDiv.classList.add('hidden');
        errorDiv.classList.add('hidden');

        if (currentTeam.length >= 6) {
            errorDiv.textContent = 'Seu time ja esta completo!';
            errorDiv.classList.remove('hidden');
            return;
        }

        btn.textContent = 'Carregando...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/suggest-team', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    team: currentTeam.map(p => ({ name: p.name })),
                    format: format
                })
            });

            const data = await res.json();

            if (data.error) {
                errorDiv.innerHTML = `
                    <p>${data.error}</p>
                    <p style="margin-top: 0.5rem; font-size: 0.75rem;">
                        Para usar as sugestoes da IA, configure a variavel de ambiente ANTHROPIC_API_KEY no Railway.
                    </p>
                `;
                errorDiv.classList.remove('hidden');
                return;
            }

            if (data.sugestoes) {
                suggestionsDiv.innerHTML = data.sugestoes.map(s => `
                    <div class="ai-suggestion" onclick="addSuggestedPokemon('${s.pokemon}')">
                        <div class="ai-suggestion-header">
                            <img src="${getSprite(s.pokemon)}" onerror="this.style.opacity='0.3'">
                            <strong>${s.pokemon}</strong>
                            <span class="ai-suggestion-role">${s.role || ''}</span>
                        </div>
                        <p class="ai-suggestion-reason">${s.motivo}</p>
                    </div>
                `).join('');
            }

            if (data.dica_geral) {
                tipDiv.innerHTML = `<strong>Dica:</strong> ${data.dica_geral}`;
                tipDiv.classList.remove('hidden');
            }

            if (data.raw_response) {
                suggestionsDiv.innerHTML = `<pre style="white-space: pre-wrap; font-size: 0.8rem;">${data.raw_response}</pre>`;
            }

        } catch (e) {
            errorDiv.textContent = 'Erro ao obter sugestoes: ' + e.message;
            errorDiv.classList.remove('hidden');
        } finally {
            btn.textContent = 'Pedir Sugestoes';
            btn.disabled = false;
        }
    }

    function addSuggestedPokemon(name) {
        // Try to find in cache first
        if (pokemonCache[name]) {
            addPokemon(pokemonCache[name]);
        } else {
            // Add with just the name
            addPokemon({ name: name, usage: 0 });
        }
    }

    function updateExport() {
        const exportText = document.getElementById('export-text');
        const filledTeam = team.filter(p => p !== null);

        if (filledTeam.length === 0) {
            exportText.value = '';
            return;
        }

        const sets = filledTeam.map(p => {
            let lines = [p.name];

            if (p.items && p.items[0]) {
                lines[0] += ` @ ${p.items[0].name}`;
            }

            if (p.abilities && p.abilities[0]) {
                lines.push(`Ability: ${p.abilities[0].name}`);
            }

            if (p.tera_types && p.tera_types[0]) {
                lines.push(`Tera Type: ${p.tera_types[0].name}`);
            }

            if (p.spreads && p.spreads[0]) {
                const s = p.spreads[0];
                const evs = [];
                if (s.hp > 0) evs.push(`${s.hp} HP`);
                if (s.atk > 0) evs.push(`${s.atk} Atk`);
                if (s.def > 0) evs.push(`${s.def} Def`);
                if (s.spa > 0) evs.push(`${s.spa} SpA`);
                if (s.spd > 0) evs.push(`${s.spd} SpD`);
                if (s.spe > 0) evs.push(`${s.spe} Spe`);
                if (evs.length > 0) lines.push(`EVs: ${evs.join(' / ')}`);
                lines.push(`${s.nature} Nature`);
            }

            if (p.moves) {
                p.moves.slice(0, 4).forEach(m => lines.push(`- ${m.name}`));
            }

            return lines.join('\n');
        });

        exportText.value = sets.join('\n\n');
    }

    function copyExport() {
        const exportText = document.getElementById('export-text');
        exportText.select();
        document.execCommand('copy');
        alert('Time copiado!');
    }

    // Load top pokemon on page load
    loadTopPokemon();
</script>
{% endblock %}
