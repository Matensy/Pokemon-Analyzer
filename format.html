<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PokeStatsBR - Estatísticas de Pokémon">
    <title>Carregando... - PokeStatsBR</title>
    <link rel="icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" alt="Pokeball" class="logo-icon">
                <span class="logo-text">PokeStats<span class="logo-br">BR</span></span>
            </a>
            <nav class="nav">
                <a href="index.html" class="nav-link">Formatos</a>
                <a href="about.html" class="nav-link">Sobre</a>
                <a href="https://pokemonshowdown.com" target="_blank" rel="noopener" class="nav-link external">Showdown</a>
            </nav>
            <button class="mobile-menu-btn" aria-label="Menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html" class="mobile-menu-link">Formatos</a>
        <a href="about.html" class="mobile-menu-link">Sobre</a>
        <a href="https://pokemonshowdown.com" target="_blank" rel="noopener" class="mobile-menu-link">Showdown</a>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="index.html">Formatos</a>
                <span class="breadcrumb-sep">/</span>
                <span class="breadcrumb-current" id="breadcrumb-format">Carregando...</span>
            </nav>

            <!-- Format Header -->
            <header class="format-header">
                <h1 class="format-title" id="format-title">Carregando...</h1>
                <p class="format-code-display" id="format-code"></p>
            </header>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <label for="rating-select">Rating:</label>
                    <select id="rating-select" class="select">
                        <option value="0">0 (Todos)</option>
                        <option value="1500">1500</option>
                        <option value="1630">1630</option>
                        <option value="1760" selected>1760 (Top)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="month-select">Mês:</label>
                    <select id="month-select" class="select">
                        <option value="2024-11">2024-11</option>
                        <option value="2024-10">2024-10</option>
                        <option value="2024-09">2024-09</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="search-input">Buscar:</label>
                    <input type="text" id="search-input" class="input" placeholder="Nome do Pokémon...">
                </div>
            </div>

            <!-- Stats Info -->
            <div id="stats-info" class="stats-info">
                <span class="info-item"><strong id="total-pokemon">-</strong> Pokémon</span>
                <span class="info-item"><strong id="total-battles">-</strong> Batalhas</span>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando dados do Smogon...</p>
            </div>

            <!-- Error -->
            <div id="error" class="error hidden">
                <p id="error-message">Erro ao carregar dados.</p>
                <button onclick="loadData()" class="btn btn-primary">Tentar Novamente</button>
            </div>

            <!-- Pokemon List -->
            <div id="pokemon-list" class="pokemon-list hidden"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p class="footer-brand">PokeStatsBR</p>
                    <p class="footer-desc">Estatísticas do Pokémon Showdown em português.</p>
                </div>
                <div class="footer-links">
                    <h4>Links</h4>
                    <a href="https://www.smogon.com/stats/" target="_blank" rel="noopener">Smogon Stats</a>
                    <a href="https://pokemonshowdown.com" target="_blank" rel="noopener">Pokémon Showdown</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Pokémon e todos os nomes relacionados são marca registrada Nintendo 1996-2024.</p>
            </div>
        </div>
    </footer>

    <script src="static/js/main.js"></script>
    <script>
        // Get format from URL
        const urlParams = new URLSearchParams(window.location.search);
        const FORMAT_CODE = urlParams.get('format') || 'gen9ou';

        // Format names
        const FORMAT_NAMES = {
            'gen9vgc2025regh': '[Gen 9] VGC 2025 Reg H',
            'gen9vgc2025regg': '[Gen 9] VGC 2025 Reg G',
            'gen9ou': '[Gen 9] OverUsed',
            'gen9ubers': '[Gen 9] Ubers',
            'gen9uu': '[Gen 9] UnderUsed',
            'gen9ru': '[Gen 9] RarelyUsed',
            'gen9nu': '[Gen 9] NeverUsed',
            'gen9pu': '[Gen 9] PU',
            'gen9lc': '[Gen 9] Little Cup',
            'gen9monotype': '[Gen 9] Monotype',
            'gen9doublesou': '[Gen 9] Doubles OU',
            'gen9doublesubers': '[Gen 9] Doubles Ubers',
            'gen9doublesuu': '[Gen 9] Doubles UU',
            'gen9nationaldex': '[Gen 9] National Dex',
            'gen9nationaldexubers': '[Gen 9] National Dex Ubers',
            'gen9nationaldexmonotype': '[Gen 9] National Dex Monotype',
            'gen9anythinggoes': '[Gen 9] Anything Goes',
            'gen9randombattle': '[Gen 9] Random Battle',
            'gen9balancedhackmons': '[Gen 9] Balanced Hackmons',
            'gen91v1': '[Gen 9] 1v1',
            'gen8ou': '[Gen 8] OverUsed',
            'gen7ou': '[Gen 7] OverUsed',
            'gen6ou': '[Gen 6] OverUsed',
            'gen5ou': '[Gen 5] OverUsed',
        };

        // Special ratings for OU formats
        const SPECIAL_RATINGS = ['gen9ou', 'gen9doublesou'];

        let currentData = null;

        // Update page info
        function updatePageInfo() {
            const formatName = FORMAT_NAMES[FORMAT_CODE] || FORMAT_CODE;
            document.title = `${formatName} - PokeStatsBR`;
            document.getElementById('format-title').textContent = formatName;
            document.getElementById('format-code').textContent = FORMAT_CODE;
            document.getElementById('breadcrumb-format').textContent = formatName;

            // Update rating options for special formats
            const ratingSelect = document.getElementById('rating-select');
            if (SPECIAL_RATINGS.includes(FORMAT_CODE)) {
                ratingSelect.innerHTML = `
                    <option value="0">0 (Todos)</option>
                    <option value="1500">1500</option>
                    <option value="1695">1695</option>
                    <option value="1825" selected>1825 (Top)</option>
                `;
            }
        }

        // Get Showdown sprite
        function getShowdownSprite(name) {
            const normalized = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            return `https://play.pokemonshowdown.com/sprites/gen5/${normalized}.png`;
        }

        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Create Pokemon card
        function createPokemonCard(pokemon, rank) {
            const usage = (pokemon.usage * 100).toFixed(2);
            const sprite = getShowdownSprite(pokemon.name);
            const rating = document.getElementById('rating-select').value;
            const month = document.getElementById('month-select').value;

            return `
                <a href="pokemon.html?format=${FORMAT_CODE}&pokemon=${encodeURIComponent(pokemon.name)}&rating=${rating}&month=${month}"
                   class="pokemon-card">
                    <div class="pokemon-rank">#${rank}</div>
                    <img src="${sprite}" alt="${pokemon.name}" class="pokemon-sprite"
                         onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'">
                    <div class="pokemon-info">
                        <span class="pokemon-name">${pokemon.name}</span>
                        <div class="pokemon-usage">
                            <div class="usage-bar">
                                <div class="usage-fill" style="width: ${Math.min(parseFloat(usage), 100)}%"></div>
                            </div>
                            <span class="usage-text">${usage}%</span>
                        </div>
                    </div>
                </a>
            `;
        }

        // Render Pokemon list
        function renderPokemonList(data) {
            const container = document.getElementById('pokemon-list');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            // Convert data object to sorted array
            let pokemonList = Object.entries(data.data)
                .map(([name, info]) => ({ name, ...info }))
                .sort((a, b) => b.usage - a.usage);

            // Filter by search
            if (searchTerm) {
                pokemonList = pokemonList.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            if (pokemonList.length === 0) {
                container.innerHTML = '<p class="no-results">Nenhum Pokémon encontrado.</p>';
                return;
            }

            container.innerHTML = pokemonList.map((p, i) => createPokemonCard(p, i + 1)).join('');
        }

        // Load data from Smogon
        async function loadData() {
            const rating = document.getElementById('rating-select').value;
            const month = document.getElementById('month-select').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const list = document.getElementById('pokemon-list');

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            list.classList.add('hidden');

            try {
                // Use CORS proxy for Smogon Stats
                const smogonUrl = `https://www.smogon.com/stats/${month}/chaos/${FORMAT_CODE}-${rating}.json`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(smogonUrl)}`;

                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                currentData = await response.json();

                // Update stats info
                const totalPokemon = Object.keys(currentData.data).length;
                const totalBattles = currentData.info['number of battles'] || 0;

                document.getElementById('total-pokemon').textContent = totalPokemon;
                document.getElementById('total-battles').textContent = formatNumber(totalBattles);

                // Render list
                renderPokemonList(currentData);

                loading.classList.add('hidden');
                list.classList.remove('hidden');

            } catch (err) {
                console.error('Error loading data:', err);
                loading.classList.add('hidden');
                document.getElementById('error-message').textContent =
                    `Erro ao carregar dados. Verifique se o formato "${FORMAT_CODE}" existe para o mês selecionado.`;
                error.classList.remove('hidden');
            }
        }

        // Event listeners
        document.getElementById('rating-select').addEventListener('change', loadData);
        document.getElementById('month-select').addEventListener('change', loadData);
        document.getElementById('search-input').addEventListener('input', () => {
            if (currentData) renderPokemonList(currentData);
        });

        // Initialize
        updatePageInfo();
        loadData();
    </script>
</body>
</html>
